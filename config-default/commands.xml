<commands>
  <command cmd="^;mship (\S+)$" flag="c">
  <![CDATA[
    $conn->privmsg($event->{to}->[0], $1 . " is on: " . ASM::Util->commaAndify(@{$::sn{lc $1}->{mship}}));
  ]]>
  </command>
  <command cmd="^;source$">
  <![CDATA[
    $conn->privmsg($event->{to}->[0], "source is at http://svn.linuxrulz.org/repos/antispammeta");
  ]]>
  </command>
  <command cmd="^;sql (main|log) (.*)" flag="d">
  <![CDATA[
    my $dbh = $::db->{DBH};
    if ($1 eq 'log') {
      $dbh = $::db->{DBH_LOG};
    }
    $::db->raw($conn, $event->{to}->[0], $dbh, $2);
  ]]>
  </command>
  <command cmd="^;monitor (\S+) (yes|no)$" flag="a">
  <![CDATA[
    my $chan = lc $1;
    my $switch = lc $2;
    my $link = ASM::Util->getLink(lc $chan);
    if ( lc $link ne lc $chan ) {
      $conn->privmsg($event->{to}->[0], "Error: $chan is linked to $link - use $link instead.");
      return;
    }
    $::channels->{channel}->{$chan}->{monitor} = $switch;
    ASM::XML->writeChannels();
    $conn->privmsg($event->{to}->[0], "Monitor flag for $chan set to $switch");
  ]]>
  </command>
  <command cmd="^;help$">
  <![CDATA[
    $conn->privmsg($event->{to}->[0], "help is at http://meta.wikimedia.org/wiki/User:WHeimbigner/AntiSpamMeta");
    $conn->privmsg($event->{to}->[0], "You can also get faster help by emailing william dot heimbigner at ttu dot edu - or bug ErrantEgo or tomaw");
  ]]>
  </command>
  <command cmd="^;db$">
  <![CDATA[
    $conn->privmsg($event->{to}->[0], "db is at http://antispammeta.net/query.html");
  ]]>
  </command>
  <command cmd="^;query (\S+) (\S+)$">
  <![CDATA[
    my $channel = $1;
    my @nuh = split(/(\!|\@)/, $2);
    my $result = $::db->query($channel, $nuh[0], $nuh[2], $nuh[4]);
    $conn->privmsg($event->{to}->[0], "$result results found.");
  ]]>
  </command>
  <command cmd="^;userx add (\S+) (\S+)$" flag="a">
  <![CDATA[
    my $acct = lc $1;
    my $flags = $2;
    if ($flags =~ /d/) {
      $conn->privmsg($event->{to}->[0], "The d flag may not be assigned over IRC. Edit the configuration manually.");
      return;
    }
    $::users->{person}->{$acct} = { 'flags' => $flags };
    ASM::XML->writeUsers();
    $conn->privmsg($event->{to}->[0], "Flags for NickServ account $acct set to $flags");
  ]]>
  </command>
  <command cmd="^;user add (\S+) ?(\S*)$" flag="a">
  <![CDATA[
    $conn->privmsg($event->{to}->[0], "This command has been deprecated");
  ]]>
  </command>
  <command cmd="^;userx? flags (\S+) ?$">
  <![CDATA[
    my $nick = lc $1;
    if (defined($::users->{person}->{$nick}->{flags})) {
      $conn->privmsg($event->{to}->[0], "Flags for $nick: $::users->{person}->{$nick}->{flags}");
    } else {
      $conn->privmsg($event->{to}->[0], "$nick has no flags");
    }
  ]]>
  </command>
  <command cmd="^;userx? flags (\S+) (\S+)$" flag="a">
  <![CDATA[
    my $nick = lc $1;
    my $flags = $2;
    if ($flags =~ /d/) {
      $conn->privmsg($event->{to}->[0], "The d flag may not be assigned over IRC. Edit the configuration manually.");
      return;
    }
    $::users->{person}->{$nick}->{flags} = $flags;
    ASM::XML->writeUsers();
    $conn->privmsg($event->{to}->[0], "Flags for $nick set to $flags");
  ]]>
  </command>
  <command cmd="^;userx? del (\S+)$" flag="a">
  <![CDATA[
    my $nick = lc $1;
    delete($::users->{person}->{$nick});
    ASM::XML->writeUsers();
    $conn->privmsg($event->{to}->[0], "Byebye $nick");
  ]]>
  </command>
  <command cmd="^;target (\S+) (\S+) ?(\S*)$" flag="a">
  <![CDATA[
    my $chan = $1;
    my $nick = lc $2;
    my $level= $3;
    my $link = ASM::Util->getLink(lc $chan);
    if ( lc $link ne lc $chan ) {
      $conn->privmsg($event->{to}->[0], "Error: $chan is linked to $link - use $link instead.");
      return;
    }
    if ($level eq '') { $level = 'low'; }
    unless (defined($::channels->{channel}->{$chan}->{msgs})) {
      $::channels->{channel}->{$chan}->{msgs} = {};
    }
    unless (defined($::channels->{channel}->{$chan}->{msgs}->{$level})) {
      $::channels->{channel}->{$chan}->{msgs}->{$level} = [];
    }
    my @tmphl = @{$::channels->{channel}->{$chan}->{msgs}->{$level}};
    push(@tmphl, $nick);
    $::channels->{channel}->{$chan}->{msgs}->{$level} = \@tmphl;
    ASM::XML->writeChannels();
    $conn->privmsg($event->{to}->[0], "$nick added to $level risk messages for $chan");
  ]]>
  </command>
  <command cmd="^;detarget (\S+) (\S+)" flag="a">
  <![CDATA[
    my $chan = $1;
    my $nick = $2;
    my $link = ASM::Util->getLink(lc $chan);
    if ( lc $link ne lc $chan ) {
      $conn->privmsg($event->{to}->[0], "Error: $chan is linked to $link - use $link instead.");
      return;
    }
    foreach my $risk ( keys %::RISKS ) {
      next unless defined($::channels->{channel}->{$chan}->{msgs}->{$risk});
      my @ppl = @{$::channels->{channel}->{$chan}->{msgs}->{$risk}};
      @ppl = grep { lc $_ ne lc $nick } @ppl;
      $::channels->{channel}->{$chan}->{msgs}->{$risk} = \@ppl;
    }
    ASM::XML->writeChannels();
    $conn->privmsg($event->{to}->[0], "$nick removed from targets for $chan");
  ]]>
  </command>
  <command cmd="^;showhilights (\S+)$" flag="h">
  <![CDATA[
    my $nick = lc $1;
    my @channels = ();
    foreach my $chan (keys(%{$::channels->{channel}})) {
      foreach my $level (keys(%{$::channels->{channel}->{$chan}->{hilights}})) {
        if (grep(/^${nick}$/i, @{$::channels->{channel}->{$chan}->{hilights}->{$level}})) {
          push @channels, $chan . " ($level)";
        }
      }
    }
    if (! @channels) {
      $conn->privmsg($event->{to}->[0], "$nick isn't on any hilights");
    } else {
      $conn->privmsg($event->{to}->[0], "$nick is hilighted for " . join(', ', @channels));
    }
  ]]>
  </command>
  <command cmd="^;hilight (\S+) (\S+) ?(\S*)$" flag="h">
  <![CDATA[
    my $chan = $1;
    my $nick = $2;
    my $level= $3;
    if ($level eq '') { $level = 'low'; }
    $level = lc $level;
    if ($level !~ /^(disable|debug|low|medium|high|opalert)$/) {
      $conn->privmsg($event->{to}->[0], "Error: I don't recognize $level as a valid level.");
      return;
    }
    my $link = ASM::Util->getLink(lc $chan);
    if ( lc $link ne lc $chan ) {
      $conn->privmsg($event->{to}->[0], "Error: $chan is linked to $link - use $link instead.");
      return;
    }
    unless (defined($::channels->{channel}->{$chan}->{hilights})) {
      $::channels->{channel}->{$chan}->{hilights} = {};
    }
    unless (defined($::channels->{channel}->{$chan}->{hilights}->{$level})) {
      $::channels->{channel}->{$chan}->{hilights}->{$level} = [];
    }
    my @tmphl = @{$::channels->{channel}->{$chan}->{hilights}->{$level}};
    push(@tmphl, $nick);
    $::channels->{channel}->{$chan}->{hilights}->{$level} = \@tmphl;
    ASM::XML->writeChannels();
    $conn->privmsg($event->{to}->[0], "$nick added to $level risk hilights for $chan");
  ]]>
  </command>
  <command cmd="^;dehilight (\S+) (\S+)" flag="h">
  <![CDATA[
    my $chan = $1;
    my $nick = $2;
    my $link = ASM::Util->getLink(lc $chan);
    if ( lc $link ne lc $chan ) {
      $conn->privmsg($event->{to}->[0], "Error: $chan is linked to $link - use $link instead.");
      return;
    }
    foreach my $risk ( keys %::RISKS ) {
      next unless defined($::channels->{channel}->{$chan}->{hilights}->{$risk});
      my @ppl = @{$::channels->{channel}->{$chan}->{hilights}->{$risk}};
      @ppl = grep { lc $_ ne lc $nick } @ppl;
      $::channels->{channel}->{$chan}->{hilights}->{$risk} = \@ppl;
    }
    ASM::XML->writeChannels();
    $conn->privmsg($event->{to}->[0], "Removing hilights for $nick in $chan");
  ]]>
  </command>
  <command cmd="^;join (\S+)" flag="a">
  <![CDATA[
    my $chan = $1;
    unless (defined($::channels->{channel}->{$chan})) {
      $::channels->{channel}->{$chan} = { 'op' => 'no' };
      ASM::XML->writeChannels();
    }
    $conn->join($chan);
    my @autojoins = @{$::settings->{autojoins}};
    @autojoins = (@autojoins, $chan);
    $::settings->{autojoins} = \@autojoins;
    ASM::XML->writeSettings();
  ]]>
  </command>
  <command cmd="^;part (\S+)" flag="a">
  <![CDATA[
    my $chan = $1;
    $conn->part($chan);
    my @autojoins = @{$::settings->{autojoins}};
    @autojoins = grep { lc $_ ne lc $chan } @autojoins;
    $::settings->{autojoins} = \@autojoins;
    ASM::XML->writeSettings();
  ]]>
  </command>
  <command cmd="^;sl (.*)" flag="d">
  <![CDATA[
    $conn->sl($1);
  ]]>
  </command>
  <command cmd="^;quit ?(.*)" flag="a">
  <![CDATA[
    $conn->quit($1);
  ]]>
  </command>
  <command cmd="^;ev (.*)" flag="d">
  <![CDATA[
    eval $1; warn $@ if $@;
  ]]>
  </command>
  <command cmd="^;rehash$" flag="a">
  <![CDATA[
    ASM::XML->readXML();
    my @strbl = io('string_blacklist.txt')->getlines;
    chomp @strbl;
    @::string_blacklist = @strbl;
    my @eline=io('exempt.txt')->getlines;
    chomp @eline;
    %::eline = ();
    foreach my $item (@eline) {
	$::eline{lc $item} = 1;
    }
    $conn->privmsg($event->{to}->[0], 'config files were re-read');
  ]]>
  </command>
  <command cmd="^;say (.*)" flag="t">
  <![CDATA[
    $conn->privmsg($event->{to}->[0], $1);
  ]]>
  </command>
  <command cmd="^;do (.*)" flag="t">
  <![CDATA[
    $conn->me($event->{to}->[0], $1);
  ]]>
  </command>
  <command cmd="^;exempt (.*)" flag="o">
  <![CDATA[
    my $x = lc $1;
    $::eline{$x} = 1;
    $x . "\n" >> io 'exempt.txt';
    $conn->privmsg($event->{to}->[0], $x . " exempted");
  ]]>
  </command>
  <command cmd="^\!ops ?(#\S+)? ?(.*)" nohush="nohush">
  <![CDATA[
#    if ($::sn{lc $event->{nick}}->{dnsbl} == 0) {
      my $tgt = $event->{to}->[0];
      $tgt = $1 if (defined($1));
      my $msg = $1;
      $msg = $2 if defined($2);
      unless (defined($::ignored{$tgt}) && ($::ignored{$tgt} >= $::RISKS{'opalert'})) {
        $::ignored{$tgt} = $::RISKS{'opalert'};
        $conn->schedule(30, sub { delete($::ignored{$tgt})});
        my $hilite=ASM::Util->commaAndify(ASM::Util->getAlert($tgt, 'opalert', 'hilights'));
        my $txtz = "[\x02$tgt\x02] - $event->{nick} wants op attention ($msg) $hilite";
        foreach my $tgt2 (ASM::Util->getAlert($tgt, 'opalert', 'msgs')) { #unfortunately wikipedia has way too many ops, and it breaks things
          if (length($txtz) <= 380) {
            $conn->privmsg($tgt2, $txtz);
          } else {
            my $splitpart = rindex($txtz, " ", 380);
            $conn->privmsg($tgt2, substr($txtz, 0, $splitpart));
            $conn->privmsg($tgt2, substr($txtz, $splitpart));
          }
        }
      }
#    }
  ]]>
  </command>
  <command cmd="^;blacklist (.*)" flag="o">
  <![CDATA[
    my $str = lc $1;
    push(@::string_blacklist, $str);
    "$str\n" >> io 'string_blacklist.txt';
    $conn->privmsg($event->{to}->[0], "$str blacklisted");
  ]]>
  </command>
</commands>
